<?xml version="1.0" encoding="UTF-8"?>
<!--
  Eventra Platform — Logback Configuration
  ─────────────────────────────────────────
  Profiles:
    dev  → Human-readable colored console output
    prod → Structured JSON (Logstash encoder) for log aggregation
    default (no profile) → Console with correlation IDs

  MDC fields injected by CorrelationFilter:
    requestId       — UUID per HTTP request
    traceId         — OpenTelemetry trace ID
    spanId          — OpenTelemetry span ID
    userId          — Authenticated user ID
    userRole        — User role (ORGANIZER, COMPANY, ADMIN)
    clientIp        — Client IP address
    wsSessionId     — WebSocket session ID (messaging only)
    paymentTxnId    — Payment transaction ID (payment flows only)

  SECURITY: No JWT tokens, passwords, API secrets, or PII (email/phone)
            are ever included in log patterns. Sensitive headers are
            filtered at the CorrelationFilter level.
-->
<configuration scan="true" scanPeriod="30 seconds">

    <!-- ═══════════════════════════════════════════════
         Properties
         ═══════════════════════════════════════════════ -->
    <springProperty scope="context" name="APP_NAME" source="spring.application.name" defaultValue="eventra"/>

    <!-- Console pattern with correlation IDs (dev + fallback) -->
    <property name="CONSOLE_PATTERN"
              value="%d{yyyy-MM-dd HH:mm:ss.SSS} %highlight(%-5level) [%thread] %cyan(%logger{36}) — %msg [req=%X{requestId:-none} trace=%X{traceId:-none} user=%X{userId:-anon}]%n"/>

    <!-- ═══════════════════════════════════════════════
         Console Appender (dev / default)
         ═══════════════════════════════════════════════ -->
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>${CONSOLE_PATTERN}</pattern>
        </encoder>
    </appender>

    <!-- ═══════════════════════════════════════════════
         JSON Appender (production — Logstash encoder)
         Outputs one JSON object per log line, compatible with:
         Loki, ELK/EFK, CloudWatch, Datadog, Splunk
         ═══════════════════════════════════════════════ -->
    <appender name="JSON_STDOUT" class="ch.qos.logback.core.ConsoleAppender">
        <encoder class="net.logstash.logback.encoder.LogstashEncoder">
            <!-- Include all MDC fields automatically -->
            <includeMdcKeyName>requestId</includeMdcKeyName>
            <includeMdcKeyName>traceId</includeMdcKeyName>
            <includeMdcKeyName>spanId</includeMdcKeyName>
            <includeMdcKeyName>userId</includeMdcKeyName>
            <includeMdcKeyName>userRole</includeMdcKeyName>
            <includeMdcKeyName>clientIp</includeMdcKeyName>
            <includeMdcKeyName>wsSessionId</includeMdcKeyName>
            <includeMdcKeyName>paymentTxnId</includeMdcKeyName>

            <!-- Static fields -->
            <customFields>{"service":"${APP_NAME}","environment":"${SPRING_PROFILES_ACTIVE:-unknown}"}</customFields>

            <!-- Shorten logger names in JSON -->
            <shortenedLoggerNameLength>36</shortenedLoggerNameLength>

            <!-- Stack trace as a single field (not multi-line) -->
            <throwableConverter class="net.logstash.logback.stacktrace.ShortenedThrowableConverter">
                <maxDepthPerThrowable>30</maxDepthPerThrowable>
                <shortenedClassNameLength>20</shortenedClassNameLength>
                <rootCauseFirst>true</rootCauseFirst>
            </throwableConverter>
        </encoder>
    </appender>

    <!-- ═══════════════════════════════════════════════
         JSON File Appender (rolling, production)
         ═══════════════════════════════════════════════ -->
    <appender name="JSON_FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>logs/${APP_NAME}.log</file>
        <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
            <fileNamePattern>logs/${APP_NAME}.%d{yyyy-MM-dd}.%i.log.gz</fileNamePattern>
            <maxFileSize>100MB</maxFileSize>
            <maxHistory>30</maxHistory>
            <totalSizeCap>5GB</totalSizeCap>
        </rollingPolicy>
        <encoder class="net.logstash.logback.encoder.LogstashEncoder">
            <includeMdcKeyName>requestId</includeMdcKeyName>
            <includeMdcKeyName>traceId</includeMdcKeyName>
            <includeMdcKeyName>spanId</includeMdcKeyName>
            <includeMdcKeyName>userId</includeMdcKeyName>
            <includeMdcKeyName>userRole</includeMdcKeyName>
            <includeMdcKeyName>clientIp</includeMdcKeyName>
            <includeMdcKeyName>wsSessionId</includeMdcKeyName>
            <includeMdcKeyName>paymentTxnId</includeMdcKeyName>
            <customFields>{"service":"${APP_NAME}"}</customFields>
            <shortenedLoggerNameLength>36</shortenedLoggerNameLength>
            <throwableConverter class="net.logstash.logback.stacktrace.ShortenedThrowableConverter">
                <maxDepthPerThrowable>30</maxDepthPerThrowable>
                <shortenedClassNameLength>20</shortenedClassNameLength>
                <rootCauseFirst>true</rootCauseFirst>
            </throwableConverter>
        </encoder>
    </appender>

    <!-- ═══════════════════════════════════════════════
         Audit File Appender (financial events only)
         Retained for escrow dispute resolution / compliance.
         ═══════════════════════════════════════════════ -->
    <appender name="AUDIT_FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>logs/${APP_NAME}-audit.log</file>
        <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
            <fileNamePattern>logs/${APP_NAME}-audit.%d{yyyy-MM-dd}.%i.log.gz</fileNamePattern>
            <maxFileSize>50MB</maxFileSize>
            <maxHistory>90</maxHistory>
            <totalSizeCap>10GB</totalSizeCap>
        </rollingPolicy>
        <encoder class="net.logstash.logback.encoder.LogstashEncoder">
            <customFields>{"service":"${APP_NAME}","logType":"audit"}</customFields>
        </encoder>
    </appender>

    <!-- ═══════════════════════════════════════════════
         Audit Logger (financial transactions)
         Usage: LoggerFactory.getLogger("AUDIT")
         Retained 90 days for dispute resolution.
         ═══════════════════════════════════════════════ -->
    <logger name="AUDIT" level="INFO" additivity="false">
        <appender-ref ref="AUDIT_FILE"/>
        <!-- Also send to main output for real-time visibility -->
        <springProfile name="dev">
            <appender-ref ref="CONSOLE"/>
        </springProfile>
        <springProfile name="prod">
            <appender-ref ref="JSON_STDOUT"/>
        </springProfile>
    </logger>

    <!-- ═══════════════════════════════════════════════
         Category-specific log levels
         ═══════════════════════════════════════════════ -->

    <!-- Auth / Security — separate tuning -->
    <logger name="com.eventra.security" level="${LOG_LEVEL_AUTH:-DEBUG}"/>
    <logger name="com.eventra.controller.AuthController" level="${LOG_LEVEL_AUTH:-DEBUG}"/>

    <!-- Payments — separate tuning -->
    <logger name="com.eventra.service.PaymentService" level="${LOG_LEVEL_PAYMENTS:-DEBUG}"/>
    <logger name="com.eventra.service.EscrowService" level="${LOG_LEVEL_PAYMENTS:-DEBUG}"/>
    <logger name="com.eventra.controller.PaymentController" level="${LOG_LEVEL_PAYMENTS:-DEBUG}"/>

    <!-- Messaging — separate tuning -->
    <logger name="com.eventra.controller.WebSocketChatController" level="${LOG_LEVEL_MESSAGING:-DEBUG}"/>
    <logger name="com.eventra.service.MessageService" level="${LOG_LEVEL_MESSAGING:-DEBUG}"/>

    <!-- Rate Limiting — separate tuning -->
    <logger name="com.eventra.filter.RateLimitFilter" level="${LOG_LEVEL_RATELIMIT:-WARN}"/>
    <logger name="com.eventra.infrastructure.DistributedRateLimiter" level="${LOG_LEVEL_RATELIMIT:-WARN}"/>

    <!-- Suppress noisy framework logs -->
    <logger name="org.apache.catalina" level="WARN"/>
    <logger name="org.apache.tomcat" level="WARN"/>
    <logger name="org.mongodb.driver" level="WARN"/>
    <logger name="io.lettuce.core" level="WARN"/>
    <logger name="io.netty" level="WARN"/>
    <logger name="reactor.netty" level="WARN"/>

    <!-- ═══════════════════════════════════════════════
         Profile-based root configuration
         ═══════════════════════════════════════════════ -->

    <!-- DEV: colored console, verbose -->
    <springProfile name="dev">
        <root level="INFO">
            <appender-ref ref="CONSOLE"/>
        </root>
    </springProfile>

    <!-- PROD: JSON to stdout (for Docker/K8s log drivers) + rolling file -->
    <springProfile name="prod">
        <root level="WARN">
            <appender-ref ref="JSON_STDOUT"/>
            <appender-ref ref="JSON_FILE"/>
        </root>
    </springProfile>

    <!-- Default (no profile): console with correlation IDs -->
    <springProfile name="default">
        <root level="INFO">
            <appender-ref ref="CONSOLE"/>
        </root>
    </springProfile>

</configuration>
